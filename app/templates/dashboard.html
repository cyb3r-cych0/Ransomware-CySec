<!DOCTYPE html>
<html lang="">
<head>
    <title>Ransomware Intelligence Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-gauge"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
    canvas {
        filter: drop-shadow(0 0 10px rgba(0,255,255,0.3));
    }
    </style>
</head>

<body class="bg-gray-950 text-gray-200 font-mono selection:bg-cyan-500">

<div class="p-8 max-w-7xl mx-auto">

    <h1 class="text-4xl font-bold text-cyan-400 mb-6">
        Ransomware Intelligence Dashboard
    </h1>

    <!-- URL INPUT -->
    <div class="flex gap-4 mb-6">
        <input id="urlInput"
               type="text"
               placeholder="Enter website URL (https://example.com)"
               class="flex-1 p-3 bg-gray-900 rounded border border-gray-700 text-white">

        <button onclick="runScan()"
                class="bg-cyan-500 px-6 py-3 rounded text-black font-bold hover:bg-cyan-400">
            Scan
        </button>
        <button onclick="stopScan()"
                class="bg-red-500 px-6 py-3 rounded text-black font-bold hover:bg-red-400">
            Stop
        </button>
    </div>

    <!-- KPI CARDS -->
    <div class="grid grid-cols-4 gap-6 mb-10">
        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Total Links</h2>
            <p id="totalLinks" class="text-3xl text-green-400">0</p>
        </div>

        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>High Risk</h2>
            <p id="highRisk" class="text-3xl text-red-500">0</p>
        </div>

        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Medium Risk</h2>
            <p id="mediumRisk" class="text-3xl text-yellow-400">0</p>
        </div>

        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Status</h2>
            <p id="status" class="text-3xl text-cyan-400">Idle</p>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="grid grid-cols-4 gap-6 mb-10">
        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Time Taken</h2>
            <p id="timeTaken" class="text-3xl text-green-400 timeTakenValue">0 sec</p>
        </div>

        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Severity (Threat Index)</h2>
            <p id="analysis" class="text-3xl text-red-400 analysisValue">0</p>
        </div>

        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Ransomware Type</h2>
            <p id="ransomwareType" class="text-xl text-yellow-400 ransomTypeValue">
                ...
            </p>
        </div>

        <div class="bg-gray-900 p-6 rounded-xl">
            <h2>Web Security</h2>
            <p id="security" class="text-3xl text-cyan-400 webSecurityValue">0%</p>
        </div>
    </div>

    <!--  Animated Progress Bar  -->
    <div class="w-full bg-gray-800 rounded-full h-4 mb-6">
        <div id="progressBar"
             class="bg-cyan-500 h-4 rounded-full transition-all duration-300"
             style="width:0%">
        </div>
    </div>

    <!-- CHARTS -->
    <div class="grid grid-cols-2 gap-10 mb-10">
        <div>
            <canvas id="riskBarChart"></canvas>
            <p class="text-center text-gray-400 mt-2">
                Risk Score Distribution (Per Page)
            </p>
        </div>
        <div>
            <canvas id="entropyChart"></canvas>
            <p class="text-center text-gray-400 mt-2">
                Entropy Detection Distribution
            </p>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-10 mb-10 mt-5">
        <div>
            <canvas id="riskGauge"></canvas>
        </div>
        <div>
            <canvas id="ransomwareTypeChart"></canvas>
        </div>
    </div>

    <!--  Export Buttons  -->
    <div class="flex gap-4 mb-4">
        <button onclick="exportJSON()"
                class="bg-green-600 px-4 py-2 rounded">
            Export JSON Report
        </button>
    </div>

    <!-- THREAT TABLE -->
    <div class="bg-gray-900 rounded-xl p-6 overflow-x-auto">
        <h2 class="text-xl mb-4 text-cyan-400">Threat Intelligence Table</h2>
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-gray-700">
                    <th class="p-2 text-left">URL</th>
                    <th>Risk</th>
                    <th>Keyword</th>
                    <th>Entropy</th>
                    <th>Status</th>
                    <th>Ransomware Type</th>
                </tr>
            </thead>
            <tbody id="resultsTable"></tbody>
        </table>
    </div>

</div>

<script>

function detectRansomwareType(r) {

    if (r.keyword_detected && r.high_entropy)
        return "File-Encrypting Ransomware";

    if (r.keyword_detected)
        return "Ransomware Landing Page";

    if (r.high_entropy)
        return "Encrypted Payload Distribution";

    return "No Active Ransomware Detected";
}

let eventSource = null;
let scanStartTime = null;
let scanStopped = false;
let barChart, entropyChart, gaugeChart, ransomwareTypeChart;
let liveResults = [];

function runScan() {

    const url = document.getElementById("urlInput").value;
    if (!url) return alert("Enter URL");

    document.getElementById("status").innerText = "Initializing...";
    document.getElementById("resultsTable").innerHTML = "";
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("totalLinks").innerText = "0";

    liveResults = [];
    let totalLinks = 0;

    eventSource = new EventSource(`/scan-stream?url=${url}`);
    scanStartTime = Date.now();
    scanStopped = false;

    eventSource.onmessage = function(event) {

        const parsed = JSON.parse(event.data);

        // --- CRAWLING START ---
        if (parsed.type === "crawl_start") {
            document.getElementById("status").innerText = "Crawling...";
        }

        // --- LINK FOUND ---
        if (parsed.type === "link_found") {
            totalLinks = parsed.total_found;
            document.getElementById("totalLinks").innerText = totalLinks;

            // crawling progress pulse animation
            document.getElementById("progressBar").style.width =
                Math.min(totalLinks * 2, 90) + "%";
        }

        // --- CRAWL COMPLETE ---
        if (parsed.type === "crawl_complete") {
            document.getElementById("status").innerText = "Scanning...";
            document.getElementById("progressBar").style.width = "0%";
        }

        // --- SCAN RESULT ---
        if (parsed.type === "scan_result") {

            liveResults.push(parsed.data);

            appendRow(parsed.data);
            updateLiveMetrics();
            updateCharts();   // <-- ADD THIS LINE

            const progress = (parsed.current / parsed.total) * 100;
            document.getElementById("progressBar").style.width = progress + "%";
        }

        if (parsed.type === "complete") {

            const endTime = Date.now();
            const duration = ((endTime - scanStartTime) / 1000).toFixed(2);

            document.getElementById("status").innerText = "Complete";
            document.querySelector(".timeTakenValue").innerText = duration + " sec";

            eventSource.close();
        }

        if (parsed.type === "error") {
            alert(parsed.message);
            eventSource.close();
        }
    };
}

function stopScan() {
    if (eventSource) {
        scanStopped = true;
        eventSource.close();
        document.getElementById("status").innerText = "Stopped";
        document.getElementById("progressBar").style.width = "0%";
    }
}

function appendRow(r) {

    const table = document.getElementById("resultsTable");

    const badge =
        r.risk_score >= 70 ? "<span class='bg-red-600 px-2 py-1 rounded text-white'>HIGH</span>" :
        r.risk_score >= 40 ? "<span class='bg-yellow-500 px-2 py-1 rounded text-black'>MEDIUM</span>" :
        "<span class='bg-green-600 px-2 py-1 rounded text-white'>LOW</span>";

    const status =
        r.risk_score >= 70 ? "⚠️ Critical Threat" :
        r.risk_score >= 40 ? "❎ Potential Threat" :
        "✅ Safe";

    const ransomwareType = detectRansomwareType(r);

    const row = `
    <tr class="border-b border-gray-800 hover:bg-gray-800 transition">
        <td class="p-2">${r.url}</td>
        <td class="font-bold">${badge}</td>
        <td>${r.keyword_detected ? "Yes" : "No"}</td>
        <td>${r.high_entropy ? "Yes" : "No"}</td>
        <td>${status}</td>
        <td>
            <span class="bg-gray-800 px-2 py-1 rounded text-cyan-300">
                ${ransomwareType}
            </span>
        </td>
    </tr>
    `;

    table.innerHTML += row;
}

function updateLiveMetrics() {

    const totalLinks = parseInt(document.getElementById("totalLinks").innerText) || 1;

    const high = liveResults.filter(r => r.risk_score >= 70).length;
    const medium = liveResults.filter(r => r.risk_score >= 40 && r.risk_score < 70).length;

    document.getElementById("highRisk").innerText = high;
    document.getElementById("mediumRisk").innerText = medium;

    const progress = (liveResults.length / totalLinks) * 100;
    document.getElementById("progressBar").style.width = progress + "%";

    const totalRisk = liveResults.reduce((a,b)=>a+b.risk_score,0);
    // const totalLinks = liveResults.length || 1;

    const securityScore =
        100 - ((totalRisk / (totalLinks * 100)) * 100);

    document.querySelector(".webSecurityValue").innerText =
        securityScore.toFixed(1) + "%";

    const suspicious = liveResults.find(r =>
        r.keyword_detected || r.high_entropy);

    if (suspicious) {
        document.querySelector(".ransomTypeValue").innerText =
            detectRansomwareType(suspicious);
    }

    const highs = liveResults.filter(r => r.risk_score >= 70).length;
    const mediums = liveResults.filter(r => r.risk_score >= 40 && r.risk_score < 70).length;

    const threatIndex =
        ((highs * 3) + (mediums * 2)) / (liveResults.length || 1);

    document.querySelector(".analysisValue").innerText =
        threatIndex.toFixed(2);
}

function calculateRansomwareTypeCounts() {

    const counts = {
        "File-Encrypting Ransomware": 0,
        "Ransomware Landing Page": 0,
        "Encrypted Payload Distribution": 0,
        "No Active Ransomware Detected": 0
    };

    liveResults.forEach(r => {
        const type = detectRansomwareType(r);
        counts[type]++;
    });

    return counts;
}

// Update Charts
function updateCharts() {
    if (liveResults.length === 0) return;

    // --- AGGREGATED SEVERITY COUNTS ---
    const highCount = liveResults.filter(r => r.risk_score >= 70).length;
    const mediumCount = liveResults.filter(r => r.risk_score >= 40 && r.risk_score < 70).length;
    const lowCount = liveResults.filter(r => r.risk_score < 40).length;

    const labels = ["High Risk", "Medium Risk", "Low Risk"];
    const total = liveResults.length || 1;

    const riskData = [
        ((highCount / total) * 100).toFixed(1),
        ((mediumCount / total) * 100).toFixed(1),
        ((lowCount / total) * 100).toFixed(1)
    ];
    const highEntropyCount = liveResults.filter(r => r.high_entropy).length;
    const normalEntropyCount = liveResults.length - highEntropyCount;

    const entropyLabels = ["High Entropy", "Normal"];
    const entropyData = [highEntropyCount, normalEntropyCount];

    if (barChart) barChart.destroy();
    if (entropyChart) entropyChart.destroy();
    if (gaugeChart) gaugeChart.destroy();
    if (ransomwareTypeChart) ransomwareTypeChart.destroy();

    barChart = new Chart(document.getElementById("riskBarChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: "Pages Detected",
                data: riskData,
                backgroundColor: [
                    "rgba(255,0,0,0.8)",      // High
                    "rgba(255,165,0,0.8)",    // Medium
                    "rgba(0,200,100,0.8)"     // Low
                ],
                borderRadius: 6
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: "#ffffff"
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: "#ffffff"
                    }
                }
            }
        }
    });

    entropyChart = new Chart(document.getElementById("entropyChart"), {
        type: 'bar',
        data: {
            labels: entropyLabels,
            datasets: [{
                label: "Pages",
                data: entropyData,
                backgroundColor: [
                    "rgba(0,255,255,0.8)",   // High Entropy
                    "rgba(0,200,100,0.8)"    // Normal
                ],
                borderRadius: 6
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: "#ffffff"
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: "#ffffff"
                    }
                }
            }
        }
    });

    const avgRisk = riskData.reduce((a,b)=>a+b,0) / riskData.length || 0;

    gaugeChart = new Chart(document.getElementById("riskGauge"), {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [avgRisk, 100-avgRisk],
                backgroundColor: ["red","gray"]
            }]
        },
        options: {
            circumference: 180,
            rotation: 270,
            cutout: "70%"
        }
    });

    const typeCounts = calculateRansomwareTypeCounts();

    ransomwareTypeChart = new Chart(
        document.getElementById("ransomwareTypeChart"),
        {
            type: 'bar',
            data: {
                labels: Object.keys(typeCounts),
                datasets: [{
                    label: "Severity %",
                    data: Object.values(typeCounts),
                    backgroundColor: [
                        "rgba(255,0,0,0.7)",      // File-Encrypting
                        "rgba(255,165,0,0.7)",    // Landing Page
                        "rgba(0,255,255,0.7)",    // Encrypted Payload
                        "rgba(0,200,100,0.7)"     // No Threat
                    ]
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        }
    );
    
}

function exportJSON() {

    const blob = new Blob([JSON.stringify(liveResults, null, 2)], {
        type: "application/json"
    });

    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "scan_results.json";
    a.click();
}

</script>

</body>
</html>
